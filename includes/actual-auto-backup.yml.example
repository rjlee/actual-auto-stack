services:
  actual-auto-backup:
    image: ghcr.io/rjlee/actual-auto-backup:${ACTUAL_IMAGE_TAG:-latest}
    container_name: actual-auto-backup
    env_file:
      - ../.env
      - ../env/actual-auto-backup.env
    restart: unless-stopped
    depends_on:
      actual-events:
        condition: service_healthy
    volumes:
      - type: bind
        source: ../state/actual-auto-backup
        target: /app/data
      - type: bind
        source: ../state/actual-auto-backup/secrets
        target: /app/secrets
      - type: bind
        source: /mnt/backup
        target: /app/data/backups
    networks:
      - default
      - proxy
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      - traefik.enable=true
      - traefik.docker.network=actual-auto-stack_proxy
      - traefik.http.routers.backup.rule=PathPrefix(`/backup`)
      - traefik.http.routers.backup.entrypoints=web
      - traefik.http.routers.backup.middlewares=backup-chain@docker
      - traefik.http.services.backup.loadbalancer.server.port=${BACKUP_HTTP_PORT:-4010}
      - traefik.http.middlewares.backup-headers.headers.customrequestheaders.X-Actual-App-Name=${BACKUP_LOGIN_NAME:-actual-auto-backup}
      - traefik.http.middlewares.backup-headers.headers.customrequestheaders.X-Actual-Cookie-Name=${BACKUP_AUTH_COOKIE_NAME:-actual-auth}
      - traefik.http.middlewares.backup-forwardauth.forwardauth.address=http://actual-auto-auth:4000/check
      - traefik.http.middlewares.backup-forwardauth.forwardauth.trustForwardHeader=true
      - traefik.http.middlewares.backup-forwardauth.forwardauth.authResponseHeaders=Set-Cookie
      - "traefik.http.middlewares.backup-forwardauth.forwardauth.authRequestHeaders=X-Actual-App-Name,X-Actual-Cookie-Name,X-Forwarded-Host,X-Forwarded-Proto,Cookie"
      - traefik.http.middlewares.backup-trim.stripprefix.prefixes=/backup
      - traefik.http.middlewares.backup-chain.chain.middlewares=backup-headers@docker,backup-forwardauth@docker,backup-trim@docker

# When enabling this include:
#   • Copy `env/actual-auto-backup.env.example` to `env/actual-auto-backup.env` and fill your Actual credentials and provider settings. Mount optional secrets (OAuth credentials, service account JSON) via `./secrets` if needed.
#   • Add a shortcut to `env/actual-auto-auth.env`, for example:
#       STACK_LINK_ACTUAL_AUTO_BACKUP=/backup/
#       STACK_LABEL_ACTUAL_AUTO_BACKUP=actual-auto-backup

services:
  actual-monzo-pots:
    image: ghcr.io/rjlee/actual-monzo-pots:${ACTUAL_IMAGE_TAG:-latest}
    container_name: actual-monzo-pots
    env_file:
      - ../.env
      - ../env/actual-monzo-pots.env
    environment:
      BUDGET_DIR: /app/data/budget
      HTTP_PORT: ${MONZO_HTTP_PORT}
      AUTH_COOKIE_NAME: ${MONZO_AUTH_COOKIE_NAME:-monzo-auth}
    restart: unless-stopped
    depends_on:
      actual-events:
        condition: service_healthy
    volumes:
      - type: bind
        source: ../state/actual-monzo-pots
        target: /app/data
    networks:
      - default
      - proxy
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      - traefik.enable=true
      - traefik.docker.network=actual-auto-stack_proxy
      - traefik.http.routers.monzo.rule=PathPrefix(`/monzo`)
      - traefik.http.routers.monzo.entrypoints=web
      - traefik.http.routers.monzo.middlewares=monzo-chain@docker
      - traefik.http.services.monzo.loadbalancer.server.port=${MONZO_HTTP_PORT:-3000}
      - traefik.http.middlewares.monzo-static-headers.headers.customrequestheaders.X-Actual-App-Name=${MONZO_LOGIN_NAME:-Actual Monzo Pots}
      - traefik.http.middlewares.monzo-static-headers.headers.customrequestheaders.X-Actual-Cookie-Name=${MONZO_AUTH_COOKIE_NAME:-monzo-auth}
      - traefik.http.middlewares.monzo-forwardauth.forwardauth.address=http://actual-auto-auth:4000/check
      - traefik.http.middlewares.monzo-forwardauth.forwardauth.trustForwardHeader=true
      - traefik.http.middlewares.monzo-forwardauth.forwardauth.authResponseHeaders=Set-Cookie
      - "traefik.http.middlewares.monzo-forwardauth.forwardauth.authRequestHeaders=X-Actual-App-Name,X-Actual-Cookie-Name,X-Forwarded-Host,X-Forwarded-Proto,Cookie"
      - traefik.http.middlewares.monzo-trim.stripprefix.prefixes=/monzo
      - traefik.http.middlewares.monzo-chain.chain.middlewares=monzo-static-headers@docker,monzo-forwardauth@docker,monzo-trim@docker
      - traefik.http.routers.monzo-callback.rule=PathPrefix(`/monzo/auth/callback`)
      - traefik.http.routers.monzo-callback.entrypoints=web
      - traefik.http.routers.monzo-callback.priority=120
      - traefik.http.routers.monzo-callback.middlewares=monzo-trim@docker
      - traefik.http.routers.monzo-callback.service=monzo@docker

# When enabling this include, create `env/actual-monzo-pots.env` (or extend an existing env file)
# with values such as:
#   MONZO_LOGIN_NAME="Actual Monzo Pots"
#   MONZO_AUTH_COOKIE_NAME=monzo-auth
#   STACK_LINK_ACTUAL_MONZO_POTS=/monzo/
#   STACK_LABEL_ACTUAL_MONZO_POTS="${MONZO_LOGIN_NAME}"
# so the shared auth gateway can surface a shortcut on the home page.

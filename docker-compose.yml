# YAML anchors to DRY common config
x-shared-env-file: &shared_env_file ./.env
x-common-env: &common_env
  BUDGET_DIR: /app/data/budget
x-default-logging: &default_logging
  driver: json-file
  options:
    max-size: "10m"
    max-file: "3"
services:
  traefik:
    image: traefik:2.11
    container_name: actual-auto-traefik
    command:
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --entrypoints.web.address=:80
      - --api=true
      - --api.dashboard=true
      - --log.level=DEBUG
      - --accesslog=true
    ports:
      - "${STACK_HTTP_PORT:-3000}:80"
    networks:
      - proxy
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    depends_on:
      - actual-auto-auth
    labels:
      - traefik.enable=true
      - traefik.http.routers.dashboard.rule=PathPrefix(`/dashboard`) || PathPrefix(`/api`)
      - traefik.http.routers.dashboard.entrypoints=web
      - traefik.http.routers.dashboard.middlewares=dashboard-chain@docker
      - traefik.http.routers.dashboard.service=api@internal
      - traefik.http.middlewares.dashboard-headers.headers.customrequestheaders.X-Actual-App-Name=${STACK_DASHBOARD_NAME:-actual-auto-traefik}
      - traefik.http.middlewares.dashboard-headers.headers.customrequestheaders.X-Actual-Cookie-Name=${AUTH_FORWARD_COOKIE_NAME:-actual-auth}
      - traefik.http.middlewares.dashboard-forwardauth.forwardauth.address=http://actual-auto-auth:4000/check
      - traefik.http.middlewares.dashboard-forwardauth.forwardauth.trustForwardHeader=true
      - traefik.http.middlewares.dashboard-forwardauth.forwardauth.authResponseHeaders=Set-Cookie
      - "traefik.http.middlewares.dashboard-forwardauth.forwardauth.authRequestHeaders=X-Actual-App-Name,X-Actual-Cookie-Name,X-Forwarded-Host,X-Forwarded-Proto,Cookie"
      - traefik.http.middlewares.dashboard-chain.chain.middlewares=dashboard-headers@docker,dashboard-forwardauth@docker
      - traefik.http.routers.root.rule=Path(`/`)
      - traefik.http.routers.root.entrypoints=web
      - traefik.http.routers.root.middlewares=home-chain@docker
      - traefik.http.routers.root.service=auth@docker
      - traefik.http.middlewares.home-headers.headers.customrequestheaders.X-Actual-App-Name=${STACK_HOME_TITLE:-Actual Automation Stack}
      - traefik.http.middlewares.home-headers.headers.customrequestheaders.X-Actual-Cookie-Name=${AUTH_FORWARD_COOKIE_NAME:-actual-auth}
      - traefik.http.middlewares.home-forwardauth.forwardauth.address=http://actual-auto-auth:4000/check
      - traefik.http.middlewares.home-forwardauth.forwardauth.trustForwardHeader=true
      - traefik.http.middlewares.home-forwardauth.forwardauth.authResponseHeaders=Set-Cookie
      - "traefik.http.middlewares.home-forwardauth.forwardauth.authRequestHeaders=X-Actual-App-Name,X-Actual-Cookie-Name,X-Forwarded-Host,X-Forwarded-Proto,Cookie"
      - traefik.http.middlewares.home-chain.chain.middlewares=home-headers@docker,home-forwardauth@docker

  actual-events:
    image: ghcr.io/rjlee/actual-events:${ACTUAL_IMAGE_TAG:-latest}
    container_name: actual-events
    env_file:
      - *shared_env_file
      - ./env/actual-events.env
    environment:
      <<: *common_env
      HTTP_PORT: ${EVENTS_HTTP_PORT}
    ports:
      - "${EVENTS_HTTP_PORT:-3000}:${EVENTS_HTTP_PORT:-3000}"
    restart: unless-stopped
    volumes:
      - type: bind
        source: ./state/actual-events
        target: /app/data
    logging: *default_logging

  actual-auto-auth:
    image: ${AUTH_FORWARD_IMAGE:-ghcr.io/rjlee/actual-auto-auth:latest}
    container_name: actual-auto-auth
    env_file:
      - *shared_env_file
      - ./env/actual-auto-auth.env
    restart: unless-stopped
    networks:
      - proxy
      - default
    environment:
      AUTH_COOKIE_NAME: ${AUTH_FORWARD_COOKIE_NAME:-actual-auth}
      STACK_HOME_TITLE: ${STACK_HOME_TITLE:-Actual Automation Stack}
      STACK_NAV_LINKS: ${STACK_NAV_LINKS:-}
      STACK_INCLUDE_DEFAULT_LINKS: ${STACK_INCLUDE_DEFAULT_LINKS:-true}
      STACK_INCLUDE_CATEGORISE_LINK: ${STACK_INCLUDE_CATEGORISE_LINK:-true}
      CATEGORISE_LOGIN_NAME: ${CATEGORISE_LOGIN_NAME:-actual-auto-categorise}
      STACK_LINK_TRAEFIK_DASHBOARD: /dashboard/
      STACK_LABEL_TRAEFIK_DASHBOARD: ${STACK_DASHBOARD_NAME:-actual-auto-traefik}
      STACK_LINK_ACTUAL_AUTO_CATEGORISE: /categorise/
      STACK_LABEL_ACTUAL_AUTO_CATEGORISE: ${CATEGORISE_LOGIN_NAME:-actual-auto-categorise}
    labels:
      - traefik.enable=true
      - traefik.docker.network=actual-auto-stack_proxy
      - traefik.http.routers.auth.rule=PathPrefix(`/auth`)
      - traefik.http.routers.auth.entrypoints=web
      - traefik.http.routers.auth.priority=100
      - traefik.http.services.auth.loadbalancer.server.port=4000

  actual-auto-categorise:
    image: ghcr.io/rjlee/actual-auto-categorise:${ACTUAL_IMAGE_TAG:-latest}
    container_name: actual-auto-categorise
    env_file:
      - *shared_env_file
      - ./env/actual-auto-categorise.env
    environment:
      <<: *common_env
      AUTH_COOKIE_NAME: ${CATEGORISE_AUTH_COOKIE_NAME:-actual-auth}
      HTTP_PORT: ${CATEGORISE_HTTP_PORT:-3000}
    restart: unless-stopped
    depends_on:
      actual-events:
        condition: service_healthy
    volumes:
      - type: bind
        source: ./state/actual-auto-categorise
        target: /app/data
    logging: *default_logging
    networks:
      - default
      - proxy
    labels:
      - traefik.enable=true
      - traefik.docker.network=actual-auto-stack_proxy
      - traefik.http.routers.categorise.rule=PathPrefix(`/categorise`)
      - traefik.http.routers.categorise.entrypoints=web
      - traefik.http.routers.categorise.middlewares=categorise-chain@docker
      - traefik.http.services.categorise.loadbalancer.server.port=${CATEGORISE_HTTP_PORT:-3000}
      - traefik.http.middlewares.categorise-static-headers.headers.customrequestheaders.X-Actual-App-Name=${CATEGORISE_LOGIN_NAME:-actual-auto-categorise}
      - traefik.http.middlewares.categorise-static-headers.headers.customrequestheaders.X-Actual-Cookie-Name=${CATEGORISE_AUTH_COOKIE_NAME:-actual-auth}
      - traefik.http.middlewares.categorise-forwardauth.forwardauth.address=http://actual-auto-auth:4000/check
      - traefik.http.middlewares.categorise-forwardauth.forwardauth.trustForwardHeader=true
      - traefik.http.middlewares.categorise-forwardauth.forwardauth.authResponseHeaders=Set-Cookie
      - "traefik.http.middlewares.categorise-forwardauth.forwardauth.authRequestHeaders=X-Actual-App-Name,X-Actual-Cookie-Name,X-Forwarded-Host,X-Forwarded-Proto,Cookie"
      - traefik.http.middlewares.categorise-trim.stripprefix.prefixes=/categorise
      - traefik.http.middlewares.categorise-chain.chain.middlewares=categorise-static-headers@docker,categorise-forwardauth@docker,categorise-trim@docker

  actual-auto-reconcile:
    image: ghcr.io/rjlee/actual-auto-reconcile:${ACTUAL_IMAGE_TAG:-latest}
    container_name: actual-auto-reconcile
    env_file:
      - *shared_env_file
      - ./env/actual-auto-reconcile.env
    environment:
      <<: *common_env
    restart: unless-stopped
    command: ["--mode", "daemon"]
    depends_on:
      actual-events:
        condition: service_healthy
    volumes:
      - type: bind
        source: ./state/actual-auto-reconcile
        target: /app/data
    logging: *default_logging

  actual-tx-linker:
    image: ghcr.io/rjlee/actual-tx-linker:${ACTUAL_IMAGE_TAG:-latest}
    container_name: actual-tx-linker
    env_file:
      - *shared_env_file
      - ./env/actual-tx-linker.env
    environment:
      <<: *common_env
    restart: unless-stopped
    command: ["--mode", "daemon"]
    depends_on:
      actual-events:
        condition: service_healthy
    volumes:
      - type: bind
        source: ./state/actual-tx-linker
        target: /app/data
    logging: *default_logging

networks:
  proxy:
